<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <!--=============== Bootstrap ===============-->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    />
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!--=============== CSS ===============-->
    <link rel="stylesheet" href="../assets/css/productStyle.css" />
    <!--=============== JS ===============-->
    <script src="../assets/js/product.js"></script>
</head>
<body>
    <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#productModal">
        Add Product
      </button>
    <!-- ==================Add Product Modal======================= -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Add Product</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form">
                        <form id="productForm" enctype="multipart/form-data">
                            <label for="productName">Product Name: <span id="nameError"></span></label>
                            <input type="text" id="productName" name="productName">
                            <br><br>
                            <label for="productDescription">Description: <span id="descriptionError"></span></label>
                            <textarea id="productDescription" name="productDescription"></textarea>
                            <br><br>
                            <label for="productCategory">Category: <span id="categoryError"></span></label>
                            <input type="text" id="productCategory" name="productCategory">
                            <br><br>
                            <label for="productPrice">Price: <span id="priceError"></span></label>
                            <input type="number" id="productPrice" name="productPrice">
                            <br><br>
                            <label for="productQuantity">Quantity: <span id="quantityError"></span></label>
                            <input type="number" id="productQuantity" name="productQuantity">
                            <br><br>
                            <label for="productImage">Image: <span id="imageError"></span></label>
                            <input type="file" id="productImage" name="productImage">
                            <br><br>
                            <button type="submit" class="btn btn-success">Add Product</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h1>Product List</h1>
    <table id="productTable" class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Image</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <!-- Toast message container -->
    <div id="toast" class="toast" style="position: fixed; bottom: 10px; right: 10px;"></div>
</body>

<!-- =================================Script================================= -->

<script>
    const baseUrl = 'http://localhost:5062/api';

    document.getElementById('productForm').addEventListener('submit', handleProductFormSubmit);

    async function handleProductFormSubmit(event) {
        event.preventDefault();

        clearErrorMessages();
        const formData = getFormData();

        if (!validateForm(formData)) {
            return;
        }

        try {
            const responseData = await submitProductForm(formData);
            addProductToTable(responseData);
            resetForm();
            showToast('Product added successfully', 'success');
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function clearErrorMessages() {
        document.getElementById('nameError').textContent = '';
        document.getElementById('descriptionError').textContent = '';
        document.getElementById('categoryError').textContent = '';
        document.getElementById('priceError').textContent = '';
        document.getElementById('quantityError').textContent = '';
        document.getElementById('imageError').textContent = '';
    }

    function getFormData() {
        const formData = new FormData();
        formData.append('name', document.getElementById('productName').value);
        formData.append('description', document.getElementById('productDescription').value);
        formData.append('categoryName', document.getElementById('productCategory').value);
        formData.append('price', parseFloat(document.getElementById('productPrice').value));
        formData.append('quantity', parseInt(document.getElementById('productQuantity').value));
        formData.append('image', document.getElementById('productImage').files[0]);
        return formData;
    }

    function validateForm(data) {
        let isValid = true;

        if (!data.get('name')) {
            isValid = false;
            document.getElementById('nameError').textContent = 'Product name is required';
        }
        if (!data.get('description')) {
            isValid = false;
            document.getElementById('descriptionError').textContent = 'Description is required';
        }
        if (!data.get('categoryName')) {
            isValid = false;
            document.getElementById('categoryError').textContent = 'Category is required';
        }
        if (!data.get('price')) {
            isValid = false;
            document.getElementById('priceError').textContent = 'Price is required';
        } else if (data.get('price') <= 0) {
            isValid = false;
            document.getElementById('priceError').textContent = 'Price must be greater than 0';
        }
        if (!data.get('quantity')) {
            isValid = false;
            document.getElementById('quantityError').textContent = 'Quantity is required';
        } else if (data.get('quantity') <= 0) {
            isValid = false;
            document.getElementById('quantityError').textContent = 'Quantity must be greater than 0';
        }
        if (!data.get('image')) {
            isValid = false;
            document.getElementById('imageError').textContent = 'Image is required';
        }

        return isValid;
    }

    async function submitProductForm(formData) {
        const response = await fetch(`${baseUrl}/Product`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.errorMessage || 'Failed to add product');
        }

        return await response.json();
    }

    function addProductToTable(product) {
        //console.log(product);
        const { id, name, description, category, quantity, price, imageUrl } = product;

        const newRow = document.createElement('tr');

        const idCell = document.createElement('td');
        idCell.textContent = id;
        newRow.appendChild(idCell);

        const nameCell = document.createElement('td');
        nameCell.textContent = name;
        newRow.appendChild(nameCell);

        const descriptionCell = document.createElement('td');
        descriptionCell.textContent = description;
        newRow.appendChild(descriptionCell);

        const categoryCell = document.createElement('td');
        categoryCell.textContent = category.name;
        newRow.appendChild(categoryCell);

        const quantityCell = document.createElement('td');
        quantityCell.textContent = quantity;
        newRow.appendChild(quantityCell);

        const priceCell = document.createElement('td');
        priceCell.textContent = price;
        newRow.appendChild(priceCell);

        const imageCell = document.createElement('td');
        const image = document.createElement('img');
        image.src = imageUrl;
        image.alt = name;
        image.width = 50;
        image.height = 50;
        imageCell.appendChild(image);
        newRow.appendChild(imageCell);

        document.querySelector('#productTable tbody').appendChild(newRow);
    }

    function resetForm() {
        document.getElementById('productForm').reset();
    }

    function showToast(message, status) {
        const toast = document.getElementById("toast");
        toast.className = `toast show ${status}`;
        toast.textContent = message;
        setTimeout(function() {
            toast.className = toast.className.replace("show", "");
        }, 3000);

        var closeButton = document.querySelector('.toast .close');
        closeButton.onclick = function() {
            var toast = this.parentElement;
            toast.style.visibility = 'hidden';
        };
    }

    // Fetch and display existing products on page load
    async function fetchAndDisplayProducts() {
        try {
            const response = await fetch(`${baseUrl}/Product`);
            if (!response.ok) {
                throw new Error('Failed to fetch products');
            }
            const products = await response.json();
            products.forEach(addProductToTable);
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // Load existing products when the page loads
    document.addEventListener('DOMContentLoaded', fetchAndDisplayProducts);
</script>
</html>
